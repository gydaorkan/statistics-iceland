<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hagstofa √çslands - Gagnasafn</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Hagstofa √çslands - Gagnasafn</h1>
            <p class="subtitle">Vef√æj√≥nusta fyrir t√∂lfr√¶√∞ig√∂gn</p>
        </header>

        <main>
            <section class="search-section">
                <h2>Leita a√∞ t√∂flum</h2>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Sl√°√∞u inn leitaror√∞...">
                    <button id="searchButton">Leita</button>
                </div>
                <div id="searchResults" class="results-container"></div>
            </section>

            <section class="tables-section">
                <h2>Tilt√¶kar t√∂flur</h2>
                <div id="tablesContainer" class="loading">
                    <p>Hle√∞ g√∂gnum...</p>
                </div>
            </section>

            <section class="data-section" id="dataSection" style="display: none;">
                <h2>G√∂gn √∫r t√∂flu</h2>
                <div id="tableMetadata"></div>
                <div id="tableData"></div>
            </section>
        </main>

        <footer>
            <p>G√∂gn fr√° <a href="https://hagstofa.is" target="_blank">Hagstofu √çslands</a></p>
        </footer>
    </div>

    <script>
        // Fetch and display available tables
        async function loadTables() {
            try {
                const response = await fetch('/api/tables');
                const tables = await response.json();
                displayTables(tables);
            } catch (error) {
                console.error('Error loading tables:', error);
                document.getElementById('tablesContainer').innerHTML = 
                    '<p class="error">Villa vi√∞ a√∞ s√¶kja t√∂flur</p>';
            }
        }

        function displayTables(tables) {
            const container = document.getElementById('tablesContainer');
            container.classList.remove('loading');
            
            if (!tables || tables.length === 0) {
                container.innerHTML = '<p>Engar t√∂flur fundust</p>';
                return;
            }

            let html = '<ul class="table-list">';
            tables.forEach(item => {
                if (item.type === 'l') {
                    // Category/Folder
                    html += `<li class="category">
                        <span class="icon">üìÅ</span>
                        <strong>${item.text}</strong>
                    </li>`;
                } else if (item.type === 't') {
                    // Table
                    html += `<li class="table-item">
                        <span class="icon">üìä</span>
                        <a href="#" onclick="loadTableData('${item.id}'); return false;">
                            ${item.text}
                        </a>
                        <span class="updated">${item.updated || ''}</span>
                    </li>`;
                }
            });
            html += '</ul>';
            container.innerHTML = html;
        }

        // Search functionality
        document.getElementById('searchButton')?.addEventListener('click', async () => {
            const keyword = document.getElementById('searchInput').value;
            if (!keyword) return;

            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '<p class="loading">Leita...</p>';

            try {
                const response = await fetch(`/api/search?q=${encodeURIComponent(keyword)}`);
                const results = await response.json();
                
                if (results.length === 0) {
                    resultsContainer.innerHTML = '<p>Engar ni√∞urst√∂√∞ur fundust</p>';
                    return;
                }

                let html = '<h3>Leitarni√∞urst√∂√∞ur:</h3><ul class="table-list">';
                results.forEach(item => {
                    html += `<li class="table-item">
                        <span class="icon">üìä</span>
                        <a href="#" onclick="loadTableData('${item.id}'); return false;">
                            ${item.text}
                        </a>
                    </li>`;
                });
                html += '</ul>';
                resultsContainer.innerHTML = html;
            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = '<p class="error">Villa vi√∞ leit</p>';
            }
        });

        // Load table data
        async function loadTableData(tableId) {
            const dataSection = document.getElementById('dataSection');
            const metadataDiv = document.getElementById('tableMetadata');
            const dataDiv = document.getElementById('tableData');

            dataSection.style.display = 'block';
            metadataDiv.innerHTML = '<p class="loading">Hle√∞ g√∂gnum...</p>';
            dataDiv.innerHTML = '';

            try {
                // Get metadata
                const metadataResponse = await fetch(`/api/table/${tableId}`);
                const metadata = await metadataResponse.json();

                metadataDiv.innerHTML = `
                    <h3>${metadata.title || tableId}</h3>
                    <p><strong>Uppf√¶rt:</strong> ${metadata.updated || 'Ekki vita√∞'}</p>
                    <p>${metadata.description || ''}</p>
                `;

                // Get data
                const dataResponse = await fetch(`/api/table/${tableId}/data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await dataResponse.json();

                if (data.data) {
                    displayTableData(data);
                } else {
                    dataDiv.innerHTML = '<p>Engin g√∂gn √≠ bo√∞i</p>';
                }
            } catch (error) {
                console.error('Error loading table data:', error);
                metadataDiv.innerHTML = '<p class="error">Villa vi√∞ a√∞ s√¶kja g√∂gn</p>';
            }
        }

        function displayTableData(data) {
            const dataDiv = document.getElementById('tableData');
            
            // Simple display of data
            let html = '<div class="data-display"><pre>';
            html += JSON.stringify(data, null, 2);
            html += '</pre></div>';
            
            dataDiv.innerHTML = html;
        }

        // Load tables on page load
        window.addEventListener('DOMContentLoaded', loadTables);
    </script>
</body>
</html>
