<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T칬lfr칝칧i 칈slands - Statistics Iceland</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>Hagstofa 칈slands - Gagnasafn</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>游늵 T칬lfr칝칧i 칈slands</h1>
            <p class="subtitle">츼hugaver칧 g칬gn fr치 Hagstofunni</p>
        </header>

        <main>
            <section class="intro">
                <h2>Velkomin/n!</h2>
                <p>룐ssi s칤칧a birtir 치hugaver칧a t칬lfr칝칧i fr치 Hagstofu 칈slands. G칬gnin eru s칩tt beint 칰r opinni gagna쬵칩nustu Hagstofunnar.</p>
            </section>

            {% if raw_data %}
            <section class="stats-section">
                <h2>{{ raw_data.title if raw_data.title else 'Mannfj칬ldat칬lur' }}</h2>
                
                {% if raw_data.description %}
                <p class="description">{{ raw_data.description }}</p>
                {% endif %}

                <div class="data-info">
                    <p><strong>Uppf칝rt:</strong> {{ raw_data.updated if raw_data.updated else 'Ekki vita칧' }}</p>
                    <p><strong>Heimild:</strong> <a href="https://px.hagstofa.is" target="_blank">Hagstofa 칈slands</a></p>
                </div>

                {% if statistics %}
                <div class="statistics-grid">
                    {% for stat in statistics %}
                    <div class="stat-card">
                        {% for key, value in stat.items() %}
                        <div class="stat-item">
                            <span class="stat-label">{{ key }}:</span>
                            <span class="stat-value">{{ value }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="no-data">Engin g칬gn til a칧 birta.</p>
                {% endif %}
            </section>

            <section class="raw-data-section">
                <h3>Hr치g칬gn (JSON)</h3>
                <details>
                    <summary>Smelltu h칠r til a칧 sj치 hr치g칬gnin</summary>
                    <pre><code>{{ raw_data | tojson(indent=2) }}</code></pre>
                </details>
            </section>
            {% else %}
            <section class="error-section">
                <h2>丘멆잺 Villa vi칧 a칧 s칝kja g칬gn</h2>
                <p>Ekki t칩kst a칧 s칝kja g칬gn fr치 Hagstofu 칈slands. Vinsamlegast reyndu aftur s칤칧ar.</p>
            </section>
            {% endif %}
            <h1>Hagstofa 칈slands - Gagnasafn</h1>
            <p class="subtitle">Vef쬵칩nusta fyrir t칬lfr칝칧ig칬gn</p>
        </header>

        <main>
            <section class="search-section">
                <h2>Leita a칧 t칬flum</h2>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Sl치칧u inn leitaror칧...">
                    <button id="searchButton">Leita</button>
                </div>
                <div id="searchResults" class="results-container"></div>
            </section>

            <section class="tables-section">
                <h2>Tilt칝kar t칬flur</h2>
                <div id="tablesContainer" class="loading">
                    <p>Hle칧 g칬gnum...</p>
                </div>
            </section>

            <section class="data-section" id="dataSection" style="display: none;">
                <h2>G칬gn 칰r t칬flu</h2>
                <div id="tableMetadata"></div>
                <div id="tableData"></div>
            </section>
        </main>

        <footer>
            <p>G칬gn fr치 <a href="https://hagstofa.is" target="_blank">Hagstofu 칈slands</a></p>
            <p>Opin g칬gn undir Creative Commons Attribution 4.0 leyfi</p>
        </footer>
    </div>
        </footer>
    </div>

    <script>
        // Fetch and display available tables
        async function loadTables() {
            try {
                const response = await fetch('/api/tables');
                const tables = await response.json();
                displayTables(tables);
            } catch (error) {
                console.error('Error loading tables:', error);
                document.getElementById('tablesContainer').innerHTML = 
                    '<p class="error">Villa vi칧 a칧 s칝kja t칬flur</p>';
            }
        }

        function displayTables(tables) {
            const container = document.getElementById('tablesContainer');
            container.classList.remove('loading');
            
            if (!tables || tables.length === 0) {
                container.innerHTML = '<p>Engar t칬flur fundust</p>';
                return;
            }

            let html = '<ul class="table-list">';
            tables.forEach(item => {
                if (item.type === 'l') {
                    // Category/Folder
                    html += `<li class="category">
                        <span class="icon">游늬</span>
                        <strong>${item.text}</strong>
                    </li>`;
                } else if (item.type === 't') {
                    // Table
                    html += `<li class="table-item">
                        <span class="icon">游늵</span>
                        <a href="#" onclick="loadTableData('${item.id}'); return false;">
                            ${item.text}
                        </a>
                        <span class="updated">${item.updated || ''}</span>
                    </li>`;
                }
            });
            html += '</ul>';
            container.innerHTML = html;
        }

        // Search functionality
        document.getElementById('searchButton')?.addEventListener('click', async () => {
            const keyword = document.getElementById('searchInput').value;
            if (!keyword) return;

            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '<p class="loading">Leita...</p>';

            try {
                const response = await fetch(`/api/search?q=${encodeURIComponent(keyword)}`);
                const results = await response.json();
                
                if (results.length === 0) {
                    resultsContainer.innerHTML = '<p>Engar ni칧urst칬칧ur fundust</p>';
                    return;
                }

                let html = '<h3>Leitarni칧urst칬칧ur:</h3><ul class="table-list">';
                results.forEach(item => {
                    html += `<li class="table-item">
                        <span class="icon">游늵</span>
                        <a href="#" onclick="loadTableData('${item.id}'); return false;">
                            ${item.text}
                        </a>
                    </li>`;
                });
                html += '</ul>';
                resultsContainer.innerHTML = html;
            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = '<p class="error">Villa vi칧 leit</p>';
            }
        });

        // Load table data
        async function loadTableData(tableId) {
            const dataSection = document.getElementById('dataSection');
            const metadataDiv = document.getElementById('tableMetadata');
            const dataDiv = document.getElementById('tableData');

            dataSection.style.display = 'block';
            metadataDiv.innerHTML = '<p class="loading">Hle칧 g칬gnum...</p>';
            dataDiv.innerHTML = '';

            try {
                // Get metadata
                const metadataResponse = await fetch(`/api/table/${tableId}`);
                const metadata = await metadataResponse.json();

                metadataDiv.innerHTML = `
                    <h3>${metadata.title || tableId}</h3>
                    <p><strong>Uppf칝rt:</strong> ${metadata.updated || 'Ekki vita칧'}</p>
                    <p>${metadata.description || ''}</p>
                `;

                // Get data
                const dataResponse = await fetch(`/api/table/${tableId}/data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await dataResponse.json();

                if (data.data) {
                    displayTableData(data);
                } else {
                    dataDiv.innerHTML = '<p>Engin g칬gn 칤 bo칧i</p>';
                }
            } catch (error) {
                console.error('Error loading table data:', error);
                metadataDiv.innerHTML = '<p class="error">Villa vi칧 a칧 s칝kja g칬gn</p>';
            }
        }

        function displayTableData(data) {
            const dataDiv = document.getElementById('tableData');
            
            // Simple display of data
            let html = '<div class="data-display"><pre>';
            html += JSON.stringify(data, null, 2);
            html += '</pre></div>';
            
            dataDiv.innerHTML = html;
        }

        // Load tables on page load
        window.addEventListener('DOMContentLoaded', loadTables);
    </script>
</body>
</html>
